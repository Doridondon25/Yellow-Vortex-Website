<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Doctor Appointment Booking</title>
  <link rel="icon" type="image/png+xml" href="logo.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    /* General Body Styling */
    body {
      background-image: url('ron3.png');
      background-size: cover;
      background-position: center;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #2c3e50;
      margin: 0;
      padding-bottom: 60px; /* Space for footer */
    }
  
    /* Navbar Styling */
    .navbar {
      background-color: green !important;
    }
  
    .navbar-brand {
      font-size: 1.5rem;
      font-weight: bold;
      color: #fff !important;
      display: flex;
      align-items: center;
    }
  
    .navbar-brand img {
      margin-right: 10px;
    }
  
    .navbar-nav .nav-link {
      font-size: 1rem;
      font-weight: 500;
      color: #fff !important;
      transition: color 0.3s ease;
    }
  
    .navbar-nav .nav-link:hover {
      color: #d4edda !important; /* Light green hover effect */
      text-decoration: underline;
    }
  
    .navbar-toggler {
      border: none;
    }
  
    .navbar-toggler-icon {
      background-color: transparent; /* Transparent background */
      font-size: 1.5rem; /* Ensure the icon is large enough */
      color: white; /* Ensure the icon is white */
      content: "\f0c9"; /* Font Awesome hamburger icon code */
    }
    .dropdown-menu {
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .dropdown-menu {
            background-color: green; /* Light background color */
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }

        .dropdown-item {
            font-size: 1rem;
            font-weight: 500;
            color: white; /* Default text color */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dropdown-item:hover {
            background-color: #d4edda; /* Light green hover effect */
            color: black; /* Dark green text on hover */
        }

        .dropdown-divider {
            border-color: #ccc; /* Divider color */
        }

  
    /* Hero Section */
    .hero-section {
      text-align: center;
      padding: 60px 20px 20px;
      color: #fff;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(3px);
      border-radius: 12px;
      margin: 30px auto;
      max-width: 700px;
    }
  
    /* Form Section */
    .form-section {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 40px;
      max-width: 700px;
      margin: 30px auto;
    }
  
    .form-section h3 {
      color: #2980b9;
      font-weight: 700;
      margin-bottom: 30px;
      text-align: center;
    }
  
    .form-control {
      border-radius: 10px;
      padding: 12px;
      font-size: 1rem;
      border: 1px solid #ccc;
    }
  
    .form-control:focus {
      border-color: #3498db;
      box-shadow: 0 0 6px rgba(52, 152, 219, 0.3);
    }
  
    /* Buttons */
    button {
      width: 100%;
      background-color: #3498db;
      color: white;
      padding: 14px;
      font-size: 1.1rem;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      transition: 0.3s ease-in-out;
    }
  
    button:hover {
      background-color: #2980b9;
      transform: scale(1.02);
    }
  
    /* Toast Notification */
    #toast {
      z-index: 1050;
      position: fixed;
      top: 20px;
      right: 20px;
      display: none;
      background-color: #28a745;
      color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
  
    /* Alert Styling */
    .alert {
      text-align: center;
      margin-top: 20px;
    }
  
    /* Footer */
    footer {
      background-color: green;
      color: white;
      text-align: center;
      padding: 16px;
      width: 100%;
      margin-top: auto; /* Push the footer to the bottom */
      position: fixed;
      bottom: 0;
    }
  
    /* Date Picker Styling */
    .date-picker-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      width: 320px;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      z-index: 1050;
      display: none;
      flex-direction: column;
    }
  
    .date-picker-popup header {
      background-color: #3498db;
      color: white;
      padding: 12px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      border-radius: 10px 10px 0 0;
    }
  
    .date-picker-popup .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      padding: 12px;
    }
  
    .date-picker-popup .calendar div {
      text-align: center;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
      background: #ecf0f1;
      transition: background-color 0.3s;
    }
  
    .date-picker-popup .calendar div:hover {
      background-color: #d0e9ff;
    }
  
    .date-picker-popup .calendar div.selected {
      background-color: #3498db;
      color: white;
    }
  
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      display: none;
    }
    .btn {
  background-color: #28a745;
  color: white;
  padding: 14px;
  font-size: 1.1rem;
  font-weight: bold;
  border: none;
  border-radius: 10px;
  transition: all 0.3s ease-in-out;
}

.btn:hover {
  background-color: #218838;
  transform: scale(1.02);
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
}

#BookButton {
  background-color: #28a745;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-top: 10px;
}

#BookButton:active {
  transform: scale(0.98);
}

/* Add to your existing style section */
.appointment-option {
    border-radius: 8px;
    margin-bottom: 10px;
    transition: background-color 0.3s ease;
}

.appointment-option:hover {
    background-color: #f8f9fa;
}

.appointment-option .form-check-label {
    cursor: pointer;
    width: 100%;
    padding: 10px;
}

.badge {
    position: absolute;
    top: -5px;
    right: -5px;
    font-size: 0.7em;
    padding: 0.35em 0.65em;
}

/* Add to your existing style section */
#updateAppointments {
    background-color: #ffc107;
    color: #000;
    font-weight: 600;
    border: none;
    transition: all 0.3s ease;
}

#updateAppointments:hover {
    background-color: #ffb300;
    transform: scale(1.02);
}

#updateAppointments:active {
    transform: scale(0.98);
}
  </style>
  
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-success shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src="logo.png" alt="Yellow-Vortex Logo" height="50" width="70" class="me-2">
            <span class="fw-bold">Yellow-Vortex</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="home.html">Home <i class="fa-solid fa-house"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="managmet.html">Management <i class="fa-solid fa-cogs"></i></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="medication.html">Medication <i class="fa-solid fa-pills"></i></a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        More
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                      <li><a class="dropdown-item" href="profile.html">Profile <i class="fa-solid fa-user"></i></a></li>
                        <li><a class="dropdown-item" href="chat.html">Chats <i class="fa-solid fa-comments"></i></a></li>
                        <li><a class="dropdown-item" href="health-Report.html">Reports <i class="fa-solid fa-file-medical"></i></a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="logout.html">Logout <i class="fa-solid fa-arrow-right-from-bracket"></i></a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

  <div class="hero-section">
    <h1>Book Your Appointment</h1>
    <p>We are here to provide you with the best care possible.</p>
  </div>

  <div class="form-section">
    <form id="appointmentForm">
      <div class="mb-4">
        <label for="date" class="form-label">Preferred Appointment Date</label>
        <input type="text" class="form-control" id="date" placeholder="Select Date" readonly required>
      </div>
      <div class="mb-4">
        <label for="time" class="form-label">Appointment Time</label>
        <input type="text" class="form-control" id="time" readonly required>
      </div>
      <div class="mb-4">
        <label for="doctor" class="form-label">Doctor</label>
        <input type="text" class="form-control" id="doctor" readonly required>
      </div>
      <div class="mb-4">
        <label for="location" class="form-label">Location</label>
        <input type="text" class="form-control" id="location" readonly required>
      </div>
      <button type="submit" id="BookButton" class="btn w-100">Book Appointment</button>
    </form>
    <div id="confirmation" class="alert alert-success mt-4 d-none" role="alert">
      Your appointment has been successfully booked!
    </div>
    <button id="updateAppointments" class="btn btn-warning mt-4 w-100">
        <i class="fas fa-sync-alt me-2"></i> Update Appointments List
    </button>
  </div>

  <!-- Date Picker Popup -->
  <div class="overlay" id="overlay" onclick="closeDatePicker()"></div>
  <div class="date-picker-popup" id="datePicker">
    <header>
      <button type="button" onclick="changeMonth(-1)">&#9664;</button>
      <span id="calendarHeader"></span>
      <button type="button" onclick="changeMonth(1)">&#9654;</button>
    </header>
    <div class="calendar" id="calendar"></div>
  </div>

  <footer>
    <p>Â© 2025 Yellow-Vortex. All rights reserved.</p>
  </footer>

  <div id="toast" class="toast align-items-center text-bg-success border-0 position-fixed top-0 end-0 p-3" role="alert" aria-live="assertive" aria-atomic="true" style="display: none; margin-top: 20px; margin-right: 20px;">
    <div class="d-flex">
      <div class="toast-body">
        Your appointment has been successfully booked!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close" onclick="hideToast()"></button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { firebaseConfig, updateAppointmentsList, db } from './js/firebase-config.js';


    const dateField = document.getElementById("date");
    const datePicker = document.getElementById("datePicker");
    const overlay = document.getElementById("overlay");
    const calendar = document.getElementById("calendar");
    const calendarHeader = document.getElementById("calendarHeader");
    const appointmentForm = document.getElementById("appointmentForm");

    // Calendar state
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    // Event Listeners
    dateField.addEventListener("click", openDatePicker);
    overlay.addEventListener("click", closeDatePicker);

    appointmentForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = {
            date: dateField.value,
            time: document.getElementById("time").value,
            doctor: document.getElementById("doctor").value,
            location: document.getElementById("location").value,
            occupied: true,
            userId: localStorage.getItem('userId') // Add user ID to track who booked it
        };
        
        try {
            // Generate a unique ID for the new appointment
            const newAppointmentId = `appointment_${Date.now()}`;
            
            // Add the new appointment to Firebase
            await set(ref(db, `Appointments/${newAppointmentId}`), formData);
            
            // Show success message
            showToast("Appointment booked successfully!");
            
            // Clear the form
            appointmentForm.reset();
            
            // Refresh the calendar
            populateCalendar(currentMonth, currentYear);
            
        } catch (error) {
            console.error("Error booking appointment:", error);
            showToast("Failed to book appointment", "danger");
        }
    });

    async function populateCalendar(month, year) {
        calendar.innerHTML = "";
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        calendarHeader.textContent = `${monthNames[month]} ${year}`;

        try {
            const snapshot = await get(ref(db, "Appointments"));
            const appointments = snapshot.exists() ? snapshot.val() : {};

            for (let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement("div");
                dayDiv.textContent = i;
                
                const currentDate = `${year}-${String(month + 1).padStart(2, "0")}-${String(i).padStart(2, "0")}`;
                const availableAppointments = Object.values(appointments)
                    .filter(apt => apt.date === currentDate && !apt.occupied);

                if (availableAppointments.length > 0) {
                    // Green styling for available appointments
                    dayDiv.style.backgroundColor = "#d1e7dd";
                    dayDiv.style.color = "#0f5132";
                    dayDiv.dataset.appointments = availableAppointments.length;
                    dayDiv.innerHTML += `<span class="badge bg-success">${availableAppointments.length}</span>`;
                    dayDiv.onclick = () => selectDate(i, month, year);
                } else {
                    // Red styling for no appointments
                    dayDiv.style.backgroundColor = "#f8d7da";
                    dayDiv.style.color = "#842029";
                    dayDiv.style.cursor = "not-allowed";
                    dayDiv.title = "No available appointments";
                }

                calendar.appendChild(dayDiv);
            }
        } catch (error) {
            console.error("Error fetching appointments:", error);
        }
    }

    async function selectDate(day, month, year) {
        const selectedDate = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        
        try {
            const snapshot = await get(ref(db, "Appointments"));
            if (snapshot.exists()) {
                const appointments = snapshot.val();
                const availableAppointments = Object.entries(appointments)
                    .filter(([_, apt]) => apt.date === selectedDate && !apt.occupied)
                    .map(([id, apt]) => ({id, ...apt}));

                if (availableAppointments.length > 0) {
                    if (availableAppointments.length === 1) {
                        // Single appointment available
                        const apt = availableAppointments[0];
                        dateField.value = selectedDate;
                        document.getElementById("time").value = apt.time;
                        document.getElementById("doctor").value = apt.doctor;
                        document.getElementById("location").value = apt.location;
                        closeDatePicker();
                    } else {
                        // Multiple appointments available
                        showAppointmentModal(availableAppointments, selectedDate);
                    }
                } else {
                    showToast("No available appointments for this date", "warning");
                }
            } else {
                showToast("No appointments found", "warning");
            }
        } catch (error) {
            console.error("Error checking appointments:", error);
            showToast("Error checking appointments", "danger");
        }
    }

    function showAppointmentModal(appointments, selectedDate) {
        const list = document.getElementById("appointmentsList");
        list.innerHTML = appointments.map((apt, index) => `
            <div class="appointment-option p-3 ${index > 0 ? 'border-top' : ''}" data-id="${apt.id}">
                <div class="form-check">
                    <input type="radio" class="form-check-input" name="appointmentOption" 
                           value="${apt.id}" id="apt${apt.id}">
                    <label class="form-check-label" for="apt${apt.id}">
                        <strong>Time:</strong> ${apt.time}<br>
                        <strong>Doctor:</strong> ${apt.doctor}<br>
                        <strong>Location:</strong> ${apt.location}
                    </label>
                </div>
            </div>
        `).join('');

        // Add confirmation button
        list.innerHTML += `
            <div class="p-3 border-top">
                <button onclick="window.selectAppointmentOption('${selectedDate}')" 
                        class="btn btn-success w-100">Confirm Selection</button>
            </div>
        `;

        const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
        modal.show();
    }

    function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.querySelector(".toast-body").textContent = message;
        toast.className = `toast align-items-center text-bg-${type} border-0 position-fixed top-0 end-0 p-3`;
        toast.style.display = "block";
        setTimeout(() => toast.style.display = "none", 3000);
    }

    function openDatePicker() {
        populateCalendar(currentMonth, currentYear);
        datePicker.style.display = "flex";
        overlay.style.display = "block";
    }

    function closeDatePicker() {
        datePicker.style.display = "none";
        overlay.style.display = "none";
    }

    function changeMonth(direction) {
        currentMonth += direction;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        } else if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        populateCalendar(currentMonth, currentYear);
    }

    // Make functions available globally
    window.changeMonth = changeMonth;
    window.closeDatePicker = closeDatePicker;
    window.selectAppointmentOption = function(selectedDate) {
        const selected = document.querySelector('input[name="appointmentOption"]:checked');
        if (!selected) {
            showToast("Please select an appointment", "warning");
            return;
        }

        const appointmentDiv = document.querySelector(`[data-id="${selected.value}"]`);
        if (!appointmentDiv) {
            showToast("Error: Appointment not found", "danger");
            return;
        }

        const labelText = appointmentDiv.querySelector('label').innerText;
        const timeMatch = labelText.match(/Time: (.+?)\n/);
        const doctorMatch = labelText.match(/Doctor: (.+?)\n/);
        const locationMatch = labelText.match(/Location: (.+?)(\n|$)/);

        if (timeMatch && doctorMatch && locationMatch) {
            dateField.value = selectedDate;
            document.getElementById("time").value = timeMatch[1].trim();
            document.getElementById("doctor").value = doctorMatch[1].trim();
            document.getElementById("location").value = locationMatch[1].trim();

            const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentModal'));
            if (modal) {
                modal.hide();
            }
            showToast("Appointment selected successfully", "success");
        } else {
            showToast("Error: Invalid appointment data", "danger");
        }
    };

    // Initial calendar population
    populateCalendar(currentMonth, currentYear);

    // Now you can use updateAppointmentsList directly
    document.getElementById('updateAppointments').addEventListener('click', async () => {
        const success = await updateAppointmentsList();
        if (success) {
            showToast("Appointments list updated successfully!");
            populateCalendar(currentMonth, currentYear);
        } else {
            showToast("Failed to update appointments list", "danger");
        }
    });
</script>

  <!-- Include Bootstrap's JS bundle for proper hamburger functionality -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Add this before the closing </body> tag -->
  <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="appointmentModalLabel">Available Appointments</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="appointmentsList">
        </div>
      </div>
    </div>
  </div>
</body>
</html>
